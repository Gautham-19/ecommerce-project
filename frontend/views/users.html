<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Eco Cycle Store</title>
    <link rel="stylesheet" href="../public/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <button class="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <a href="home.html" class="logo">
                <i class="fas fa-leaf"></i>
                Eco Cycle Store
            </a>
            <div class="search-bar">
                <input type="text" placeholder="Search for products, brands and more">
                <button><i class="fas fa-search"></i></button>
            </div>
            <div class="nav-links">
                <a href="home.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="products.html" class="nav-link">
                    <i class="fas fa-th-large"></i>
                    <span>Products</span>
                </a>
                <a href="cart.html" class="nav-link cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Cart</span>
                    <span class="cart-count">0</span>
                </a>
                <a href="orders.html" class="nav-link">
                    <i class="fas fa-box"></i>
                    <span>Orders</span>
                </a>
                <a href="users.html" class="nav-link">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <div class="mobile-nav">
            <a href="home.html" class="nav-link">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="products.html" class="nav-link">
                <i class="fas fa-th-large"></i>
                <span>Products</span>
            </a>
            <a href="cart.html" class="nav-link">
                <i class="fas fa-shopping-cart"></i>
                <span>Cart</span>
            </a>
            <a href="orders.html" class="nav-link">
                <i class="fas fa-box"></i>
                <span>Orders</span>
            </a>
            <a href="users.html" class="nav-link">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </a>
        </div>
    </div>

    <!-- Profile Page -->
    <div class="profile-page">
        <div class="container">
            <div class="profile-container">
                <!-- Profile Sidebar -->
                <div class="profile-sidebar">
                    <div class="profile-user">
                        <div class="profile-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <h3 class="profile-name" id="profile-name">User Name</h3>
                        <p class="profile-email" id="profile-email">user@example.com</p>
                    </div>
                    <div class="profile-nav">
                        <a href="#" class="profile-nav-item active" data-tab="profile">
                            <i class="fas fa-user"></i> My Profile
                        </a>
                        <a href="#" class="profile-nav-item" data-tab="orders">
                            <i class="fas fa-box"></i> My Orders
                        </a>
                        <a href="#" class="profile-nav-item" data-tab="addresses">
                            <i class="fas fa-map-marker-alt"></i> Addresses
                        </a>
                        <a href="#" class="profile-nav-item" data-tab="wishlist">
                            <i class="fas fa-heart"></i> Wishlist
                        </a>
                        <a href="#" class="profile-nav-item" data-tab="settings">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                        <a href="#" class="profile-nav-item" data-tab="manage-users">
                            <i class="fas fa-users"></i> Manage Users
                        </a>
                    </div>
                </div>

                <!-- Profile Content -->
                <div class="profile-content">
                    <!-- Profile Tab -->
                    <div class="profile-tab" id="profile-tab">
                        <div class="profile-section">
                            <h3 class="profile-section-title">Personal Information</h3>
                            <form id="profile-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="name" placeholder="Enter your name">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email" placeholder="Enter your email">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="phone" placeholder="Enter your phone number">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Date of Birth</label>
                                        <input type="date" class="form-control" id="dob">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address" placeholder="Enter your address">
                                </div>
                                <button type="submit" class="checkout-btn">Save Changes</button>
                            </form>
                        </div>
                    </div>

                    <!-- Manage Users Tab -->
                    <div class="profile-tab" id="manage-users-tab" style="display: none;">
                        <div class="profile-section">
                            <h3 class="profile-section-title">Manage Users</h3>
                            
                            <!-- Search and filter bar -->
                            <div class="user-controls">
                                <div class="search-filter">
                                    <div class="search-input">
                                        <i class="fas fa-search"></i>
                                        <input type="text" id="user-search" placeholder="Search users...">
                                    </div>
                                    <select id="user-filter" class="filter-select">
                                        <option value="all">All Users</option>
                                        <option value="active">Active Users</option>
                                        <option value="inactive">Inactive Users</option>
                                    </select>
                                </div>
                                <button id="add-user-toggle" class="add-user-btn">
                                    <i class="fas fa-plus"></i> Add New User
                                </button>
                            </div>
                            
                            <!-- User cards container -->
                            <div class="user-cards-container" id="users-list">
                                <!-- User cards will be dynamically added here -->
                            </div>
                            
                            <!-- Pagination controls -->
                            <div class="pagination-controls">
                                <button class="pagination-btn" disabled><i class="fas fa-chevron-left"></i></button>
                                <span class="pagination-info">Page 1 of 1</span>
                                <button class="pagination-btn" disabled><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>

                        <!-- Add/Edit User Form -->
                        <div class="profile-section" id="user-form-section" style="display: none;">
                            <h3 class="profile-section-title" id="form-title">Add New User</h3>
                            <form id="user-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Name</label>
                                        <input type="text" class="form-control" id="new-name" placeholder="Enter name" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="new-email" placeholder="Enter email" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="new-phone" placeholder="Enter phone number">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Address</label>
                                        <input type="text" class="form-control" id="new-address" placeholder="Enter address">
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" id="cancel-user-btn" class="cancel-btn">Cancel</button>
                                    <button type="submit" class="checkout-btn">Add User</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3 class="footer-title">About Us</h3>
                    <p>Your one-stop shop for eco-friendly products that help reduce environmental impact.</p>
                    <div class="social-links">
                        <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3 class="footer-title">Customer Service</h3>
                    <div class="footer-links">
                        <a href="#" class="footer-link">Contact Us</a>
                        <a href="#" class="footer-link">FAQs</a>
                        <a href="#" class="footer-link">Returns & Refunds</a>
                        <a href="#" class="footer-link">Shipping Policy</a>
                        <a href="#" class="footer-link">Terms & Conditions</a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3 class="footer-title">Quick Links</h3>
                    <div class="footer-links">
                        <a href="home.html" class="footer-link">Home</a>
                        <a href="products.html" class="footer-link">Products</a>
                        <a href="cart.html" class="footer-link">Cart</a>
                        <a href="orders.html" class="footer-link">Orders</a>
                        <a href="users.html" class="footer-link">Account</a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3 class="footer-title">Contact Info</h3>
                    <div class="footer-links">
                        <a href="#" class="footer-link"><i class="fas fa-map-marker-alt"></i> UVCE, K.R Circle</a>
                        <a href="#" class="footer-link"><i class="fas fa-phone"></i> +91-7899247701, +91-8951233445</a>
                        <a href="#" class="footer-link"><i class="fas fa-envelope"></i> sphemads@gmail.com</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Eco Cycle Store. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="../public/js/users.js"></script>
    <script>
        // Mobile menu toggle
        document.querySelector('.mobile-menu-toggle').addEventListener('click', function() {
            document.querySelector('.mobile-menu').classList.toggle('active');
        });

        // Tab navigation
        document.querySelectorAll('.profile-nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Update active tab in navigation
                document.querySelectorAll('.profile-nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                this.classList.add('active');
                
                // Show selected tab content
                const tabName = this.getAttribute('data-tab');
                document.querySelectorAll('.profile-tab').forEach(tab => {
                    tab.style.display = 'none';
                });
                
                const selectedTab = document.getElementById(`${tabName}-tab`);
                if (selectedTab) {
                    selectedTab.style.display = 'block';
                }
                
                // If manage users tab is selected, fetch users
                if (tabName === 'manage-users') {
                    fetchUsers();
                }
            });
        });

        // Enhanced users display with cards
        function displayUsers(users) {
            const usersList = document.getElementById("users-list");
            usersList.innerHTML = "";

            if (users.length === 0) {
                usersList.innerHTML = `
                    <div class="empty-users">
                        <div class="empty-users-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3 class="empty-users-message">No users found</h3>
                        <p class="empty-users-description">Add a new user to get started</p>
                    </div>
                `;
                return;
            }

            users.forEach((user) => {
                // Create initials for avatar
                const initials = user.Name ? user.Name.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
                
                // Determine if user is active (for demo purposes)
                const isActive = Math.random() > 0.3; // Random active status for demo
                
                const userCard = document.createElement("div");
                userCard.className = "user-card";
                userCard.innerHTML = `
                    <div class="user-status ${isActive ? 'active' : 'inactive'}"></div>
                    <div class="user-card-header">
                        <div class="user-avatar">${initials}</div>
                        <div class="user-info">
                            <h3 class="user-name">${user.Name || 'Unnamed User'}</h3>
                            <p class="user-email">${user.Email || 'No email'}</p>
                        </div>
                    </div>
                    <div class="user-details">
                        <div class="user-detail">
                            <i class="fas fa-id-badge"></i>
                            <span>ID: ${user.User_ID}</span>
                        </div>
                        <div class="user-detail">
                            <i class="fas fa-phone"></i>
                            <span>${user.Phone_Number || 'No phone number'}</span>
                        </div>
                        <div class="user-detail">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${user.Address || 'No address'}</span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="user-action-btn edit-btn" onclick="editUser(${user.User_ID})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="user-action-btn delete-btn" onclick="deleteUser(${user.User_ID})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;

                usersList.appendChild(userCard);
            });
        }

        // Override the original function
        window.fetchUsers = function() {
            fetch("http://localhost:5000/api/users")
                .then((response) => response.json())
                .then((data) => {
                    displayUsers(data);
                    
                    // If we have at least one user, populate the profile form with the first user's data
                    if (data.length > 0) {
                        const user = data[0];
                        document.getElementById('profile-name').textContent = user.Name || 'User Name';
                        document.getElementById('profile-email').textContent = user.Email || 'user@example.com';
                        
                        document.getElementById('name').value = user.Name || '';
                        document.getElementById('email').value = user.Email || '';
                        document.getElementById('phone').value = user.Phone_Number || '';
                        document.getElementById('address').value = user.Address || '';
                    }
                })
                .catch((error) => {
                    console.error("Error fetching users:", error);
                    document.getElementById("users-list").innerHTML = `
                        <div class="empty-users">
                            <div class="empty-users-icon">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <h3 class="empty-users-message">Error loading users</h3>
                            <p class="empty-users-description">Please try again later</p>
                        </div>
                    `;
                });
        }

        // Toggle user form visibility
        document.getElementById('add-user-toggle').addEventListener('click', function() {
            const formSection = document.getElementById('user-form-section');
            formSection.style.display = 'block';
            document.getElementById('form-title').textContent = 'Add New User';
            document.getElementById('user-form').reset();
            
            // Reset form submission to add user
            const userForm = document.getElementById('user-form');
            userForm.onsubmit = addUser;
            
            // Change button text
            const submitBtn = document.querySelector('#user-form button[type="submit"]');
            submitBtn.textContent = 'Add User';
            
            // Scroll to form
            formSection.scrollIntoView({ behavior: 'smooth' });
        });

        // Cancel button
        document.getElementById('cancel-user-btn').addEventListener('click', function() {
            document.getElementById('user-form-section').style.display = 'none';
            document.getElementById('user-form').reset();
        });

        // Search functionality
        document.getElementById('user-search').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            if (searchTerm.length > 0) {
                fetch("http://localhost:5000/api/users")
                    .then((response) => response.json())
                    .then((data) => {
                        const filteredUsers = data.filter(user => 
                            (user.Name && user.Name.toLowerCase().includes(searchTerm)) || 
                            (user.Email && user.Email.toLowerCase().includes(searchTerm)) ||
                            (user.Phone_Number && user.Phone_Number.includes(searchTerm))
                        );
                        displayUsers(filteredUsers);
                    })
                    .catch((error) => console.error("Error searching users:", error));
            } else {
                fetchUsers();
            }
        });

        // Enhanced add user function
        window.addUser = function(event) {
            event.preventDefault();

            const name = document.getElementById("new-name").value;
            const email = document.getElementById("new-email").value;
            const phone = document.getElementById("new-phone").value;
            const address = document.getElementById("new-address").value;

            // Show loading state
            const addUserBtn = event.target.querySelector('button[type="submit"]');
            const originalText = addUserBtn.textContent;
            addUserBtn.disabled = true;
            addUserBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

            fetch("http://localhost:5000/api/users", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    Name: name,
                    Email: email,
                    Phone_Number: phone,
                    Address: address,
                }),
            })
            .then((response) => response.json())
            .then((data) => {
                alert(data.message || "User added successfully!");
                document.getElementById("user-form").reset();
                document.getElementById("user-form-section").style.display = 'none';
                fetchUsers();
                
                // Reset button state
                addUserBtn.disabled = false;
                addUserBtn.textContent = originalText;
            })
            .catch((error) => {
                console.error("Error adding user:", error);
                alert("Failed to add user. Please try again.");
                
                // Reset button state
                addUserBtn.disabled = false;
                addUserBtn.textContent = originalText;
            });
        }

        // Enhanced delete user function
        window.deleteUser = function(userId) {
            if (!confirm("Are you sure you want to delete this user?")) {
                return;
            }

            fetch(`http://localhost:5000/api/users/${userId}`, {
                method: "DELETE",
            })
            .then((response) => response.json())
            .then((data) => {
                alert(data.message || "User deleted successfully!");
                fetchUsers();
            })
            .catch((error) => {
                console.error("Error deleting user:", error);
                alert("Failed to delete user. Please try again.");
            });
        }

        // Edit user function
        window.editUser = function(userId) {
            // Show form section
            const formSection = document.getElementById('user-form-section');
            formSection.style.display = 'block';
            document.getElementById('form-title').textContent = 'Edit User';
            
            // Scroll to form
            formSection.scrollIntoView({ behavior: 'smooth' });
            
            // Fetch user details
            fetch(`http://localhost:5000/api/users/${userId}`)
            .then((response) => response.json())
            .then((user) => {
                // Populate form with user data
                document.getElementById('new-name').value = user.Name || '';
                document.getElementById('new-email').value = user.Email || '';
                document.getElementById('new-phone').value = user.Phone_Number || '';
                document.getElementById('new-address').value = user.Address || '';
                
                // Change button text
                const submitBtn = document.querySelector('#user-form button[type="submit"]');
                submitBtn.textContent = 'Update User';
                
                // Change form submission to update user
                const userForm = document.getElementById('user-form');
                userForm.onsubmit = function(e) {
                    e.preventDefault();
                    
                    // Show loading state
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                    
                    const updatedUser = {
                        Name: document.getElementById('new-name').value,
                        Email: document.getElementById('new-email').value,
                        Phone_Number: document.getElementById('new-phone').value,
                        Address: document.getElementById('new-address').value
                    };
                    
                    fetch(`http://localhost:5000/api/users/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedUser)
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message || 'User updated successfully!');
                        fetchUsers();
                        
                        // Reset form
                        userForm.reset();
                        formSection.style.display = 'none';
                        
                        // Reset button state
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Update User';
                    })
                    .catch(error => {
                        console.error('Error updating user:', error);
                        alert('Failed to update user. Please try again.');
                        
                        // Reset button state
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Update User';
                    });
                };
            })
            .catch((error) => {
                console.error("Error fetching user details:", error);
                alert("Failed to load user details. Please try again.");
                formSection.style.display = 'none';
            });
        }

        // Update cart count in header
        function updateCartCount() {
            fetch('http://localhost:5000/api/carts/user/1')
            .then(response => response.json())
            .then(data => {
                const cartCount = document.querySelectorAll('.cart-count');
                cartCount.forEach(count => {
                    count.textContent = data.length || 0;
                });
            })
            .catch(error => console.error('Error fetching cart count:', error));
        }

        // Call on page load
        updateCartCount();
        
        // Initialize profile
        document.addEventListener("DOMContentLoaded", () => {
            fetchUsers();
            
            // Set up form submissions
            document.getElementById("user-form").addEventListener("submit", addUser);
            
            document.getElementById("profile-form").addEventListener("submit", function(e) {
                e.preventDefault();
                alert("Profile updated successfully!");
            });
        });
    </script>
</body>
</html>

